<!DOCTYPE html>
<html>
<head>
  <title>MAUL | Live Tag Editor</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta property="og:title" content="Live Tag Editor - MAUL" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://moddedamong.us/templates.html" />
  <meta property="og:image" content="https://moddedamong.us/images/banner.png" />
  <meta property="og:description" content="Type, color, and export Among Us tags with smooth gradients in real time." />
  <meta property="og:site_name" content="Modded Among Us Lobbies" />
  <meta property="og:locale" content="en_US" />
  <link rel="canonical" href="https://moddedamong.us/templates.html" />
  <link rel="shortcut icon" type="image/png" href="images/favicon.png" />
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@300;700;900&family=VT323&family=Roboto+Mono:wght@400;700&family=Orbitron:wght@500;700&family=Press+Start+2P&family=Share+Tech+Mono&family=Rajdhani:wght@700&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet"/>
  <style>
    html, body {
      height:100%;
      margin:0;
      padding:0;
      background:#000;
      font-family:'Roboto',sans-serif;
      color:#fff;
      overflow-x:hidden;
    }
    body {
      background: linear-gradient(rgba(0,0,0,.9), rgba(0,0,0,.9)), url('images/background.png') no-repeat center center fixed;
      background-size:cover;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-bottom:100px;
    }
    header {
      width:100%;
      text-align:center;
      padding:20px;
      background:rgba(0,0,0,0.94);
      position:relative;
      z-index:1000;
    }
    header h1 {
      margin:0;
      font-size:2rem;
      color:#fff;
      letter-spacing:.5px;
    }
    .dropdown {
      position:absolute;
      top:16px;
      left:20px;
      z-index:1001;
    }
    .dropbtn {
      background:none;
      border:none;
      cursor:pointer;
      transition:transform .2s ease;
      padding:0;
    }
    .dropbtn:hover { transform:scale(1.06); }
    .hamburger {
      width:30px;
      height:22px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .hamburger span {
      display:block;
      height:4px;
      background:#fff;
      border-radius:2px;
    }
    .dropdown-content {
      display:none;
      position:absolute;
      top:30px;
      left:0;
      background:#1e1e1e;
      min-width:220px;
      box-shadow:0 8px 16px rgba(0,0,0,0.45);
      border:1px solid #343434;
      border-radius:8px;
      overflow:hidden;
    }
    .dropdown-content a {
      color:#fff;
      padding:12px 16px;
      text-decoration:none;
      display:block;
      transition:background .2s;
      border-bottom:1px solid #2a2a2a;
    }
    .dropdown-content a:last-child { border-bottom:0; }
    .dropdown-content a:hover { background:#2a2a2a; }
    .dropdown:hover .dropdown-content { display:block; }
    footer {
      position:fixed;
      bottom:0;
      left:0;
      width:100%;
      text-align:center;
      padding:12px;
      background:rgba(0,0,0,0.92);
      z-index:2;
      font-size:.9rem;
    }
    .container {
      max-width:1180px;
      width:92%;
      margin:36px auto;
      display:grid;
      gap:20px;
    }
    .panel {
      background:rgba(0,0,0,0.68);
      border:1px solid rgba(255,255,255,.12);
      border-radius:10px;
      padding:18px;
    }
    .section-title {
      font-size:1.8rem;
      text-align:center;
      margin:0 0 6px;
    }
    .section-subtitle {
      text-align:center;
      color:#e6e6e6;
      margin:0 0 16px;
      font-size:.98rem;
    }
    .grid { display:grid; gap:14px; }
    .row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .field {
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.16);
      padding:6px 10px;
      border-radius:8px;
    }
    .field input[type="text"],
    .field input[type="number"],
    .field textarea,
    .field select {
      background:rgba(0,0,0,.5);
      border:1px solid rgba(255,255,255,.24);
      border-radius:6px;
      color:#def;
      padding:8px;
    }
    .field textarea {
      width:100%;
      min-height:130px;
      resize:vertical;
    }
    .btn {
      background:rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.28);
      color:#e7f0ff;
      font-size:.92rem;
      padding:8px 12px;
      border-radius:6px;
      cursor:pointer;
      transition:background .15s, border-color .15s, transform .02s, box-shadow .15s, outline .15s;
    }
    .btn:hover {
      background:rgba(255,255,255,.18);
      border-color:rgba(255,255,255,.38);
    }
    .btn:active { transform:scale(.98); }
    .btn.active {
      outline: 2px solid #fff;
      box-shadow: 0 0 0 2px rgba(255,255,255,.25) inset;
    }
    .codebox {
      background:rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.25);
      border-radius:10px;
      padding:14px;
      font-family:'Roboto Mono', monospace;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .twocol {
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
    }
    @media (max-width:900px){
      .twocol { grid-template-columns:1fr; }
    }
    #lte-preview {
      min-height:360px;
      font-size:1.35rem;
      line-height:1.6;
      padding:16px 18px;
    }
    #lte-output {
      min-height:200px;
      font-size:1rem;
    }
    .gg-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .color-chip {
      width:40px;
      height:32px;
      border:1px solid rgba(255,255,255,.22);
      background:transparent;
    }
    .preview-bar {
      height:44px;
      border-radius:8px;
      border:1px solid #000;
      margin:6px 0;
    }
    .icon-launch { margin-left:auto; }
    .icon-palette {
      position:fixed;
      right:20px;
      bottom:80px;
      width:300px;
      max-height:360px;
      overflow:auto;
      background:#1b1b1b;
      border:1px solid #444;
      border-radius:8px;
      box-shadow:0 8px 20px rgba(0,0,0,.5);
      display:none;
      z-index:30;
    }
    .icon-palette header {
      background:#111;
      border-bottom:1px solid #333;
      padding:8px 10px;
      font-weight:700;
      font-size:.95rem;
    }
    .icon-grid {
      display:grid;
      grid-template-columns:repeat(6, 1fr);
      gap:6px;
      padding:10px;
    }
    .icon-cell {
      padding:8px;
      text-align:center;
      border:1px solid #333;
      background:#222;
      border-radius:6px;
      cursor:pointer;
      user-select:none;
      transition:transform .02s, background .15s, border-color .15s;
      font-size:1.1rem;
    }
    .icon-cell:hover {
      background:#2c2c2c;
      border-color:#555;
    }
    .icon-cell:active { transform:scale(.96); }
    #snippet-buttons {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .snippet-btn { font-size:.85rem; }
  </style>
</head>
<body>
<header>
  <h1>MAUL Live Tag Editor</h1>
  <div class="dropdown">
    <button class="dropbtn" aria-label="Open navigation menu">
      <div class="hamburger"><span></span><span></span><span></span></div>
    </button>
    <div class="dropdown-content">
      <a href="index.html">Home</a>
      <a href="https://moddedamong.us/art.html">User Art</a>
      <a href="https://moddedamong.us/eventpics.html">Past Events</a>
      <a href="https://moddedamong.us/calendar.html">Event Calendar</a>
      <a href="https://moddedamong.us/mods.html">Featured Mods</a>
      <a href="https://moddedamong.us/ourstaff.html">Our Staff</a>
      <a href="https://moddedamong.us/presets.html">Mod Presets</a>
      <a href="https://moddedamong.us/icons.html">Icons and Fonts</a>
    </div>
  </div>
</header>

<main class="container">
  <section class="panel" id="live-template-editor">
    <h2 class="section-title"><u>Live Template Editor</u></h2>
    <p class="section-subtitle">
      Select a range and click a tool: <b>Align</b>, <b>Size</b>, <b>B/I/U</b>, <b>Solid</b>, or <b>Smooth Gradient</b>.
      <b>Tab</b> inserts <code>\n</code>; <b>Shift+Enter</b> inserts a real tab.
    </p>

    <div class="grid">
      <div class="row">
        <div class="field">
          <label>Font</label>
          <select id="lte-font">
            <option>BROOK SDF</option>
            <option>VCR SDF</option>
            <option>Barlow-Black SDF</option>
            <option>Barlow-BoldItalic SDF</option>
            <option>Barlow-Light SDF</option>
            <option>CONSOLA SDF</option>
            <option>DIGITAL-7 SDF</option>
            <option>DIN_Pro_Bold_700 SDF</option>
            <option>LiberationSans SDF</option>
            <option>NotoSansJP-Regular SDF</option>
            <option>OCRAEXT SDF</option>
            <option>OCRAXT SDF</option>
          </select>
          <button class="btn" id="btn-font-wrap" title='Wrap selection in <font="...">'>Font wrap</button>
        </div>

        <div class="field">
          <label>Align</label>
          <button class="btn" data-align="left" id="al-left">Left</button>
          <button class="btn" data-align="center" id="al-center">Center</button>
          <button class="btn" data-align="right" id="al-right">Right</button>
        </div>

        <div class="field">
          <label>Size %</label>
          <input id="size-pct" type="number" min="50" max="300" step="5" value="110" style="width:90px">
          <button class="btn" id="btn-apply-size" title='<size=110%>...'>Apply</button>
        </div>

        <div class="field">
          <label>Style</label>
          <button class="btn" data-tag="b">B</button>
          <button class="btn" data-tag="i">I</button>
          <button class="btn" data-tag="u">U</button>
        </div>

        <div class="field">
          <label>Solid</label>
          <input id="lte-solid" type="color" value="#FF4D6D">
          <button class="btn" id="lte-apply-solid">Apply</button>
        </div>

        <div class="field">
          <label>Auto</label>
          <select id="auto-token" title="Insert common placeholders">
            <option value="{{PlayerName}}">{{PlayerName}}</option>
            <option value="{{HostName}}">{{HostName}}</option>
            <option value="{{ModVersion}}">{{ModVersion}}</option>
          </select>
          <button class="btn" id="auto-insert">Insert</button>
        </div>

        <div class="field">
          <label>Stops</label>
          <div class="gg-row" id="lte-stops"></div>
          <button class="btn" id="lte-add-stop" title="Add stop">Add</button>
          <button class="btn" id="lte-shuffle-stops" title="Randomize stops">Randomize</button>
          <button class="btn" id="lte-apply-gradient" title="Smooth per-char gradient">Apply gradient</button>
        </div>

        <button class="btn icon-launch" id="btn-icons">Iconsâ€¦</button>
      </div>

      <div id="lte-grad-preview" class="preview-bar" aria-label="Gradient preview"></div>

      <div class="twocol">
        <div class="grid">
          <div class="field">
            <label><strong>Editor (markup auto-generated)</strong></label>
          </div>
          <textarea id="lte-editor" placeholder="Type hereâ€¦"></textarea>
          <div class="row">
            <button class="btn" id="lte-copy">Copy markup</button>
            <button class="btn" id="lte-download">Download .txt</button>
            <span id="lte-status" aria-live="polite"></span>
          </div>
          <div class="codebox" id="lte-output"></div>
        </div>

        <div class="grid">
          <div class="field"><strong>Live Preview (renders fonts + colors)</strong></div>
          <div id="lte-preview" class="codebox"></div>
          <div class="field">
            <small>Note: SDF fonts are mapped to similar web fonts for browser preview only.</small>
          </div>
        </div>
      </div>

      <div class="panel" style="background:rgba(255,255,255,.06);">
        <div class="row">
          <div class="field" style="flex:1 1 auto">
            <label><strong>Bulk Snippet Buttons</strong></label>
            <textarea id="snippet-bulk" placeholder='Paste lines like: easteregg1:<size=130%>...\\n<size=100%>...</size>'></textarea>
          </div>
          <button class="btn" id="snippet-build">Build buttons</button>
        </div>
        <div id="snippet-buttons"></div>
      </div>
    </div>
  </section>
</main>

<footer>
  Made with â™¥ by MAUL â€” template tools for hosts &amp; creators
</footer>

<div class="icon-palette" id="icon-palette" role="dialog" aria-modal="true">
  <header>Icon Picker</header>
  <div class="icon-grid" id="icon-grid"></div>
</div>

<script>
  function copyToClipboard(text){
    if(navigator.clipboard && window.isSecureContext){
      return navigator.clipboard.writeText(text);
    }
    const ta=document.createElement('textarea');
    ta.value=text;
    ta.style.position='fixed';
    ta.style.left='-9999px';
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); }
    finally { document.body.removeChild(ta); }
    return Promise.resolve();
  }

  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));

  const normHex=(s,withHash=true)=>{
    s=(s||'').trim();
    if(!s) return withHash?'#FFFFFF':'FFFFFF';
    s=s.replace(/^#/,'').replace(/[^0-9a-fA-F]/g,'').slice(0,6);
    if(s.length===3) s=s.split('').map(c=>c+c).join('');
    if(s.length<6) s=(s+'FFFFFF').slice(0,6);
    return (withHash?'#':'')+s.toUpperCase();
  };

  const hexToRgb=h=>{
    h=normHex(h,true).slice(1);
    return {
      r:parseInt(h.slice(0,2),16),
      g:parseInt(h.slice(2,4),16),
      b:parseInt(h.slice(4,6),16)
    };
  };

  const rgbToHex=({r,g,b}) =>
    '#' + [r,g,b]
      .map(x=>Math.max(0,Math.min(255,x|0)).toString(16).padStart(2,'0'))
      .join('')
      .toUpperCase();

  const lerp=(a,b,t)=>a+(b-a)*t;

  const lerpColor=(h1,h2,t)=>{
    const c1=hexToRgb(h1), c2=hexToRgb(h2);
    return rgbToHex({
      r: lerp(c1.r,c2.r,t),
      g: lerp(c1.g,c2.g,t),
      b: lerp(c1.b,c2.b,t)
    });
  };

  const ed = document.getElementById('lte-editor');
  const out = document.getElementById('lte-output');
  const prev = document.getElementById('lte-preview');
  const fontSel = document.getElementById('lte-font');
  const statusEl = document.getElementById('lte-status');
  const solidPicker = document.getElementById('lte-solid');
  const btnSolid = document.getElementById('lte-apply-solid');
  const btnGradient = document.getElementById('lte-apply-gradient');
  const sizeInput = document.getElementById('size-pct');
  const btnApplySize = document.getElementById('btn-apply-size');
  const btnFontWrap = document.getElementById('btn-font-wrap');
  const stopsWrap = document.getElementById('lte-stops');
  const btnAddStop = document.getElementById('lte-add-stop');
  const btnShuffle = document.getElementById('lte-shuffle-stops');
  const gradPrev = document.getElementById('lte-grad-preview');
  const btnCopy = document.getElementById('lte-copy');
  const btnDL = document.getElementById('lte-download');
  const autoSel = document.getElementById('auto-token');
  const autoBtn = document.getElementById('auto-insert');

  const FONT_MAP = {
    'BROOK SDF': '"Barlow", "Rajdhani", sans-serif',
    'VCR SDF': '"VT323", monospace',
    'Barlow-Black SDF': '"Barlow", sans-serif',
    'Barlow-BoldItalic SDF': '"Barlow", sans-serif',
    'Barlow-Light SDF': '"Barlow", sans-serif',
    'CONSOLA SDF': '"Share Tech Mono", "Roboto Mono", monospace',
    'DIGITAL-7 SDF': '"Orbitron", monospace',
    'DIN_Pro_Bold_700 SDF': '"Rajdhani", sans-serif',
    'LiberationSans SDF': '"Barlow", sans-serif',
    'NotoSansJP-Regular SDF': '"Noto Sans JP", sans-serif',
    'OCRAEXT SDF': '"Press Start 2P", "VT323", monospace',
    'OCRAXT SDF': '"Press Start 2P", "VT323", monospace'
  };

  let STOPS = ['#B625F1','#2970F8','#00CFFF','#31D0AA'];
  let markup = '';
  let userStyled = false;

  const flash = (el)=>{
    el.classList.add('active');
    setTimeout(()=>el.classList.remove('active'), 600);
  };

  function getSel(){ return { s: ed.selectionStart|0, e: ed.selectionEnd|0 }; }
  const hasSelection = ()=> { const {s,e}=getSel(); return e>s; };

  const requireSelection = (btn,onOK,msg)=>{
    if(!hasSelection()){
      statusEl.textContent = msg || 'Select some text first.';
      flash(btn);
      return false;
    }
    onOK();
    return true;
  };

  const toHTML = (s) => {
    let html = s
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');

    html = html.replace(/&lt;font="([^"]+)"&gt;/g,
      (_,name)=>{
        const key=name.replace(/\s+/g,' ').trim();
        const fam=FONT_MAP[key] || 'inherit';
        return `<span style="font-family:${fam}">`;
      }
    ).replace(/&lt;\/font&gt;/g,'</span>');

    html = html.replace(/&lt;color=(#[0-9A-Fa-f]{6})&gt;/g,
      (_,hex)=>`<span style="color:${hex}">`
    ).replace(/&lt;\/color&gt;/g,'</span>');

    html = html.replace(/&lt;size=(\d{1,3})%&gt;/g,
      (_,pct)=>`<span style="font-size:${pct}%">`
    ).replace(/&lt;\/size&gt;/g,'</span>');

    html = html.replace(/&lt;align=(left|center|right)&gt;/g,
      (_,pos)=>`<div style="text-align:${pos}">`
    ).replace(/&lt;\/align&gt;/g,'</div>');

    html = html
      .replace(/&lt;b&gt;/g,'<b>').replace(/&lt;\/b&gt;/g,'</b>')
      .replace(/&lt;i&gt;/g,'<i>').replace(/&lt;\/i&gt;/g,'</i>')
      .replace(/&lt;u&gt;/g,'<u>').replace(/&lt;\/u&gt;/g,'</u>');

    html = html.replace(/\\n/g,'<br/>');
    return html;
  };

  function buildIndexMap(mark){
    const map=[], len=mark.length;
    let iPlain=0, i=0;
    while(i<len){
      if(mark.startsWith('<color=',i)){ const k=mark.indexOf('>',i); if(k===-1) break; i=k+1; continue; }
      if(mark.startsWith('</color>',i)){ i+=8; continue; }
      if(mark.startsWith('<font="',i)){ const k=mark.indexOf('>',i); if(k===-1) break; i=k+1; continue; }
      if(mark.startsWith('</font>',i)){ i+=7; continue; }
      if(mark.startsWith('<size=',i)){ const k=mark.indexOf('>',i); if(k===-1) break; i=k+1; continue; }
      if(mark.startsWith('</size>',i)){ i+=7; continue; }
      if(mark.startsWith('<align=',i)){ const k=mark.indexOf('>',i); if(k===-1) break; i=k+1; continue; }
      if(mark.startsWith('</align>',i)){ i+=8; continue; }
      if(mark.startsWith('<b>',i)||mark.startsWith('<i>',i)||mark.startsWith('<u>',i)){ i+=3; continue; }
      if(mark.startsWith('</b>',i)||mark.startsWith('</i>',i)||mark.startsWith('</u>',i)){ i+=4; continue; }
      map[iPlain++] = i;
      i++;
    }
    map[iPlain]=i;
    return map;
  }

  function replacePlainRangeWith(mark,i0,i1,repl){
    const map=buildIndexMap(mark);
    const a=map[i0] ?? mark.length;
    const b=map[i1] ?? mark.length;
    return mark.slice(0,a)+repl+mark.slice(b);
  }

  function buildSmoothGradient(str){
    const stops=STOPS.length?STOPS:['#FFFFFF'];
    const text=String(str||'');

    let visible=0,i=0;
    while(i<text.length){
      if(text[i]==='<'){ const k=text.indexOf('>',i); i=(k===-1?i+1:k+1); continue; }
      if(text[i]==='\\' && text[i+1]==='n'){ i+=2; continue; }
      visible++; i++;
    }

    const colorAt = idx=>{
      if(visible<=1) return normHex(stops[0],true);
      const t=idx/(visible-1);
      const seg=(stops.length-1)*t;
      const i0=Math.floor(seg);
      const i1=Math.min(stops.length-1,i0+1);
      const lt=seg-i0;
      return normHex(lerpColor(stops[i0],stops[i1],lt),true);
    };

    let visIdx=0; i=0;
    const out=[];
    while(i<text.length){
      if(text[i]==='<'){
        const k=text.indexOf('>',i);
        if(k===-1){ out.push(text[i++]); continue; }
        out.push(text.slice(i,k+1));
        i=k+1; continue;
      }
      if(text[i]==='\\' && text[i+1]==='n'){ out.push('\\n'); i+=2; continue; }
      out.push(`<color=${colorAt(visIdx++)}>${text[i]}</color>`);
      i++;
    }
    return out.join('');
  }

  function insertAtCaret(txt){
    const {s,e}=getSel();
    const val=ed.value;
    ed.value = val.slice(0,s)+txt+val.slice(e);
    const pos=s+txt.length;
    ed.selectionStart=ed.selectionEnd=pos;
  }

  function renderAll(){
    out.textContent = markup;
    prev.innerHTML = toHTML(markup);
  }

  function wrapSelection(open,close){
    const {s,e}=getSel();
    if(e<=s) return;
    const raw = ed.value.slice(s,e).replace(/\r?\n/g,'\\n');
    markup = replacePlainRangeWith(markup,s,e,open+raw+close);
    userStyled=true;
    renderAll();
  }

  function renderStops(){
    stopsWrap.innerHTML='';
    STOPS.forEach((hex,idx)=>{
      const row=document.createElement('div');
      row.className='row';

      const t=document.createElement('input');
      t.type='text';
      t.value=normHex(hex,true);
      t.style.width='100px';

      const c=document.createElement('input');
      c.type='color';
      c.className='color-chip';
      c.value=normHex(hex,true);

      const up=document.createElement('button');
      up.className='btn'; up.textContent='â–²';

      const dn=document.createElement('button');
      dn.className='btn'; dn.textContent='â–¼';

      const rm=document.createElement('button');
      rm.className='btn'; rm.textContent='âœ•';

      t.addEventListener('input',()=>{
        const h=normHex(t.value,true);
        t.value=h; c.value=h;
        STOPS[idx]=h; renderGradPreview(); renderAll();
      });
      c.addEventListener('input',()=>{
        const h=normHex(c.value,true);
        t.value=h; STOPS[idx]=h; renderGradPreview(); renderAll();
      });
      up.addEventListener('click',()=>{
        if(idx>0){ [STOPS[idx-1],STOPS[idx]]=[STOPS[idx],STOPS[idx-1]]; renderStops(); renderGradPreview(); renderAll(); }
      });
      dn.addEventListener('click',()=>{
        if(idx<STOPS.length-1){ [STOPS[idx+1],STOPS[idx]]=[STOPS[idx],STOPS[idx+1]]; renderStops(); renderGradPreview(); renderAll(); }
      });
      rm.addEventListener('click',()=>{
        if(STOPS.length>1){ STOPS.splice(idx,1); renderStops(); renderGradPreview(); renderAll(); }
      });

      row.append(t,c,up,dn,rm);
      stopsWrap.appendChild(row);
    });
  }

  function renderGradPreview(){
    const parts=STOPS.map((c,i)=>{
      const hex=normHex(c,true);
      const pct=i*100/(Math.max(STOPS.length-1,1));
      return `${hex} ${pct}%`;
    });
    gradPrev.style.background=`linear-gradient(90deg, ${parts.join(', ')})`;
  }

  function syncSolid(){
    if(userStyled){ renderAll(); return; }
    const solid=normHex(solidPicker.value,true);
    const text=ed.value.replace(/\r?\n/g,'\\n');
    markup = `<color=${solid}>${text}</color>`;
    renderAll();
  }
 
  btnSolid.addEventListener('click', ()=>{
    requireSelection(btnSolid, ()=>{
      const {s,e}=getSel();
      const hex=normHex(solidPicker.value,true);
      const slice=ed.value.slice(s,e).replace(/\r?\n/g,'\\n');
      markup = replacePlainRangeWith(markup,s,e,`<color=${hex}>${slice}</color>`);
      userStyled=true; renderAll();
      statusEl.textContent='Solid color applied.'; flash(btnSolid);
    },'Select text to color.');
  }); 
  btnGradient.addEventListener('click', ()=>{
    requireSelection(btnGradient, ()=>{
      const {s,e}=getSel();
      const slice=ed.value.slice(s,e).replace(/\r?\n/g,'\\n');
      const colored=buildSmoothGradient(slice);
      markup = replacePlainRangeWith(markup,s,e,colored);
      userStyled=true; renderAll();
      statusEl.textContent='Smooth gradient applied.'; flash(btnGradient);
    },'Select text for gradient.');
  });

  const alignBtns=[document.getElementById('al-left'),document.getElementById('al-center'),document.getElementById('al-right')];

  document.querySelectorAll('[data-align]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mode=btn.getAttribute('data-align');
      requireSelection(btn, ()=>{
        wrapSelection(`<align=${mode}>`,`</align>`);
        alignBtns.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        statusEl.textContent=`Alignment ${mode} applied.`;
      },'Select text to align.');
    });
  });
 
  btnApplySize.addEventListener('click', ()=>{
    let pct = clamp(parseInt(sizeInput.value||'110',10),50,300);
    sizeInput.value = pct;
    requireSelection(btnApplySize, ()=>{
      const {s,e} = getSel();
      const map = buildIndexMap(markup);
      const a = map[s] ?? markup.length;
      const b = map[e] ?? markup.length;
      const inner = markup.slice(a,b)
        .replace(/<size=\d{1,3}%>/g,'')
        .replace(/<\/size>/g,'');
      markup = markup.slice(0,a) + `<size=${pct}%>` + inner + `</size>` + markup.slice(b);
      userStyled = true;
      renderAll();
      statusEl.textContent = `Size ${pct}% applied.`;
      flash(btnApplySize);
    }, 'Select text to resize.');
  });

  document.querySelectorAll('[data-tag]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const tag=btn.getAttribute('data-tag');
      requireSelection(btn, ()=>{
        wrapSelection(`<${tag}>`,`</${tag}>`);
        statusEl.textContent=`<${tag}> applied.`;
      },`Select text to apply <${tag}>.`);
    });
  });
 
  btnFontWrap.addEventListener('click', ()=>{
    const f=fontSel.value;
    requireSelection(btnFontWrap, ()=>{
      const {s,e}=getSel();
      const map=buildIndexMap(markup);
      const a=map[s] ?? markup.length;
      const b=map[e] ?? markup.length;
      const inner = markup.slice(a,b)
        .replace(/<font="[^"]+">/g,'')
        .replace(/<\/font>/g,'');
      markup = markup.slice(0,a)+`<font="${f}">`+inner+`</font>`+markup.slice(b);
      userStyled=true; renderAll();
      statusEl.textContent=`Font "${f}" applied to selection.`; flash(btnFontWrap);
    },'Select text to apply font.');
  });
 
  autoBtn.addEventListener('click', ()=>{
    insertAtCaret(autoSel.value);
    syncSolid();
    statusEl.textContent=`Inserted ${autoSel.value}`;
    flash(autoBtn);
  });

  const randHex=()=>'#'+Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0').toUpperCase();

  btnAddStop.addEventListener('click', ()=>{
    if(STOPS.length>=10){ statusEl.textContent='Max 10 stops.'; flash(btnAddStop); return; }
    STOPS.push(randHex());
    renderStops(); renderGradPreview(); renderAll();
    statusEl.textContent=`Added stop (#${STOPS.length}).`; flash(btnAddStop);
  });

  btnShuffle.addEventListener('click', ()=>{
    STOPS=STOPS.map(()=>randHex());
    renderStops(); renderGradPreview(); renderAll();
    statusEl.textContent='Stops randomized.'; flash(btnShuffle);
  });
 
  function syncPreviewBaseFont(){
    const key=fontSel.value;
    prev.style.fontFamily = FONT_MAP[key] || 'inherit';
  }

  fontSel.addEventListener('change', ()=>{
    syncPreviewBaseFont();
    renderAll();
  });

  solidPicker.addEventListener('input', syncSolid);
  ed.addEventListener('input', syncSolid);
  ed.addEventListener('keyup', syncSolid);

  ed.addEventListener('keydown', (e)=>{
    if(e.key==='Tab' && !e.shiftKey){
      e.preventDefault();
      insertAtCaret('\\n'); syncSolid();
    } else if(e.key==='Enter' && e.shiftKey){
      e.preventDefault();
      insertAtCaret('\t'); syncSolid();
    }
  });

  btnCopy.addEventListener('click', ()=>{
    copyToClipboard(markup);
    statusEl.textContent='Markup copied to clipboard.';
    flash(btnCopy);
  });

  btnDL.addEventListener('click', ()=>{
    const blob=new Blob([markup],{type:'text/plain;charset=utf-8'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download='template.txt';
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    statusEl.textContent='Downloaded template.txt'; flash(btnDL);
  });

  const ICONS=[
    'âœ¿','â€','â–','âš½','âš¾','â™ ','â™£','â™¦','â™¥','â™¤','â™§','â™¢','â™¡','â˜¯','âœš','âš ','â€ ','âˆž','âœ“',
    'â˜Ž','â˜','â˜€','â˜','â˜‚','â˜ƒ','â˜‰','â˜…','â˜†','â‚','âœ½','â˜','â˜ž','â˜Ÿ','â˜œ','â†‘','â†“','â†’','â†','â†”','â†•',
    'âŒ˜','âŒ…','âŒ†','âŒ‡','ã€¶','âš™','âš›','âšœ','âš“','âš¡','âš•','âš’','âš–','â™©','â™ª','â™«','â™¬','â™­','â™®','â™¯',
    'â˜•','â˜˜','â˜„','â˜‡','â˜ˆ','ã€ ','ãƒ…','ãƒ„','ã‹¡','ì›ƒ','ìœ ','ã‚·','ãƒƒ','ã‹›','â—‰','â—‹','â—Ž','â—','âŠ—','âŠ™',
    'â—¯','â—‡','â—ˆ','â—','â—','â—‘','â—’','â—“','â—¦','âˆ…','âŠ•','âŠ–','âŠ˜','â¦¿','â–€','â–','â–‚','â–ƒ','â–„','â–…','â–†','â–‡',
    'â–‰','â–‹','â–ˆ','â–‘','â–’','â–“','â–¢','â–£','â–¤','â–¥','â–¦','â–§','â–¨','â–©','â–ª','â–«','â—†','â—£','â—¥','â—¤','â—¢',
    'â˜ ','â˜¢','â˜£','âš°','âš±','â™¨','â˜®','âœ ','âœ¡','â„¢','ã€°','â“‚','â™»','ðŸ†˜','ðŸ…°','ðŸ…±','ðŸ…¾','ðŸ†š'
  ];

  const btnIcons=document.getElementById('btn-icons');
  const palette=document.getElementById('icon-palette');
  const iconGrid=document.getElementById('icon-grid');

  function buildIcons(){
    iconGrid.innerHTML='';
    ICONS.forEach(ch=>{
      const cell=document.createElement('div');
      cell.className='icon-cell';
      cell.textContent=ch;
      cell.title='Insert "'+ch+'"';
      cell.addEventListener('click',()=>{
        insertAtCaret(ch);
        palette.style.display='none';
        ed.focus();
        syncSolid();
      });
      iconGrid.appendChild(cell);
    });
  }

  btnIcons.addEventListener('click',()=>{
    palette.style.display = (palette.style.display==='block'?'none':'block');
  });

  document.addEventListener('keydown',(e)=>{
    if(e.key==='Escape' && palette.style.display==='block'){
      palette.style.display='none';
    }
  });

  buildIcons();

  const snBulk=document.getElementById('snippet-bulk');
  const snBuild=document.getElementById('snippet-build');
  const snWrap=document.getElementById('snippet-buttons');

  snBuild.addEventListener('click',()=>{
    const text=snBulk.value||'';
    const lines=text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    snWrap.innerHTML='';
    for(const line of lines){
      const idx=line.indexOf(':');
      if(idx<=0) continue;
      const name=line.slice(0,idx).trim();
      const body=line.slice(idx+1).trim();
      const btn=document.createElement('button');
      btn.className='btn snippet-btn';
      btn.textContent=name;
      btn.title='Insert '+name;
      btn.addEventListener('click',()=>{
        insertAtCaret(body);
        syncSolid();
        flash(btn);
      });
      snWrap.appendChild(btn);
    }
    if(!snWrap.children.length){
      const note=document.createElement('div');
      note.style.opacity='.8';
      note.textContent='No valid name:value pairs found.';
      snWrap.appendChild(note);
    }
  });

  function syncPreviewBaseFont(){
    const key=fontSel.value;
    prev.style.fontFamily = FONT_MAP[key] || 'inherit';
  }

  function boot(){
    renderStops();
    renderGradPreview();
    syncPreviewBaseFont();
    ed.value='â™¡Bestiesâ™¡';
    syncSolid();
  }

  document.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
